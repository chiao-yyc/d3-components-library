# CLI å·¥å…·é–‹ç™¼æŒ‡å—

## æ¦‚è¿°

é€™ä»½æ–‡ä»¶è©³ç´°èªªæ˜å¦‚ä½•å»ºç«‹å’Œå¯¦ä½œ D3 Components CLI å·¥å…·ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é€é `npx d3-components add bar-chart` ç­‰å‘½ä»¤ä¾†ç®¡ç†çµ„ä»¶ã€‚

## åŸºç¤æ¦‚å¿µ

### ä»€éº¼æ˜¯ CLI å·¥å…·ï¼Ÿ
CLI (Command Line Interface) å·¥å…·æ˜¯å¯ä»¥åœ¨çµ‚ç«¯æ©Ÿä¸­åŸ·è¡Œçš„ç¨‹å¼ã€‚ç•¶ä½ åŸ·è¡Œ `npx d3-components add bar-chart` æ™‚ï¼š

1. `npx` æœƒä¸‹è¼‰ä¸¦åŸ·è¡Œ `d3-components` åŒ…
2. CLI å·¥å…·è§£æ `add bar-chart` å‘½ä»¤
3. åŸ·è¡Œå°æ‡‰çš„é‚è¼¯ï¼ˆä¸‹è¼‰çµ„ä»¶æª”æ¡ˆï¼‰

### NPX çš„é‹ä½œåŸç†
```bash
npx package-name command
# npx æœƒï¼š
# 1. æª¢æŸ¥ package-name æ˜¯å¦å·²å®‰è£
# 2. å¦‚æœæ²’æœ‰ï¼Œè‡¨æ™‚ä¸‹è¼‰åˆ°å¿«å–
# 3. åŸ·è¡Œ package.json ä¸­ bin æŒ‡å®šçš„æª”æ¡ˆ
# 4. åŸ·è¡Œå®Œç•¢å¾Œæ¸…ç†å¿«å–
```

## å°ˆæ¡ˆæ¶æ§‹

### CLI å°ˆæ¡ˆçµæ§‹
```
packages/cli/
â”œâ”€â”€ package.json           # CLI å¥—ä»¶é…ç½®
â”œâ”€â”€ tsconfig.json         # TypeScript é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # CLI å…¥å£é»
â”‚   â”œâ”€â”€ commands/         # å„ç¨®å‘½ä»¤å¯¦ä½œ
â”‚   â”‚   â”œâ”€â”€ add.ts        # add å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ init.ts       # init å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ import.ts     # import å‘½ä»¤
â”‚   â”‚   â””â”€â”€ list.ts       # list å‘½ä»¤
â”‚   â”œâ”€â”€ utils/            # å·¥å…·å‡½æ•¸
â”‚   â”‚   â”œâ”€â”€ registry.ts   # Registry API
â”‚   â”‚   â”œâ”€â”€ project.ts    # å°ˆæ¡ˆç®¡ç†
â”‚   â”‚   â”œâ”€â”€ cache.ts      # å¿«å–æ©Ÿåˆ¶
â”‚   â”‚   â””â”€â”€ templates.ts  # æ¨¡æ¿è™•ç†
â”‚   â””â”€â”€ types/            # å‹åˆ¥å®šç¾©
â”‚       â””â”€â”€ index.ts
â”œâ”€â”€ templates/            # çµ„ä»¶æ¨¡æ¿
â”‚   â””â”€â”€ component.tsx.hbs
â””â”€â”€ dist/                 # å»ºæ§‹è¼¸å‡º
    â””â”€â”€ index.js
```

## æ­¥é©Ÿä¸€ï¼šå°ˆæ¡ˆåˆå§‹åŒ–

### 1. å»ºç«‹ CLI å°ˆæ¡ˆ
```bash
mkdir packages/cli
cd packages/cli
npm init -y
```

### 2. é…ç½® package.json
```json
{
  "name": "d3-components-cli",
  "version": "1.0.0",
  "description": "D3 Components CLI tool",
  "main": "dist/index.js",
  "bin": {
    "d3-components": "./dist/index.js"
  },
  "files": [
    "dist/**/*",
    "templates/**/*"
  ],
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "test": "jest",
    "prepublishOnly": "npm run build"
  },
  "dependencies": {
    "commander": "^11.0.0",      # å‘½ä»¤è¡Œè§£æ
    "inquirer": "^9.0.0",        # äº’å‹•å¼å‘½ä»¤è¡Œ
    "chalk": "^5.0.0",           # å½©è‰²è¼¸å‡º
    "ora": "^7.0.0",             # è¼‰å…¥å‹•ç•«
    "fs-extra": "^11.0.0",       # æª”æ¡ˆç³»çµ±æ“ä½œ
    "axios": "^1.0.0",           # HTTP è«‹æ±‚
    "handlebars": "^4.7.0",      # æ¨¡æ¿å¼•æ“
    "semver": "^7.0.0"           # ç‰ˆæœ¬æ¯”è¼ƒ
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/fs-extra": "^11.0.0",
    "@types/inquirer": "^9.0.0",
    "typescript": "^5.0.0",
    "jest": "^29.0.0",
    "@types/jest": "^29.0.0"
  },
  "engines": {
    "node": ">=16"
  },
  "keywords": [
    "d3",
    "components",
    "cli",
    "visualization"
  ]
}
```

**é‡è¦èªªæ˜ï¼š**
- `bin` æ¬„ä½å®šç¾©äº†å¯åŸ·è¡Œæª”æ¡ˆçš„ä½ç½®
- `files` æ¬„ä½æŒ‡å®šç™¼å¸ƒæ™‚åŒ…å«çš„æª”æ¡ˆ
- `prepublishOnly` ç¢ºä¿ç™¼å¸ƒå‰å…ˆå»ºæ§‹

### 3. TypeScript é…ç½®
```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.test.ts"]
}
```

## æ­¥é©ŸäºŒï¼šCLI å…¥å£é»

### src/index.ts
```typescript
#!/usr/bin/env node

import { Command } from 'commander'
import chalk from 'chalk'
import { addCommand } from './commands/add'
import { initCommand } from './commands/init'
import { importCommand } from './commands/import'
import { listCommand } from './commands/list'

const program = new Command()

// åŸºæœ¬è³‡è¨Š
program
  .name('d3-components')
  .description('D3 Components CLI - é€æ˜åŒ–çš„ D3 çµ„ä»¶åº«')
  .version('1.0.0')

// è¨»å†Šå‘½ä»¤
program
  .command('add <component>')
  .description('æ·»åŠ çµ„ä»¶åˆ°å°ˆæ¡ˆä¸­')
  .option('-v, --variant <variant>', 'é¸æ“‡çµ„ä»¶è®Šé«”')
  .option('-d, --dir <directory>', 'ç›®æ¨™ç›®éŒ„', './src/components/ui')
  .option('--dry-run', 'é è¦½è®Šæ›´ä½†ä¸å¯¦éš›åŸ·è¡Œ')
  .action(addCommand)

program
  .command('init')
  .description('åˆå§‹åŒ– D3 Components å°ˆæ¡ˆ')
  .option('-t, --template <template>', 'å°ˆæ¡ˆæ¨¡æ¿', 'react')
  .action(initCommand)

program
  .command('import <file>')
  .description('åŒ¯å…¥è³‡æ–™ä¸¦ç”Ÿæˆåœ–è¡¨')
  .option('-c, --chart <type>', 'åœ–è¡¨é¡å‹')
  .option('--auto-detect', 'è‡ªå‹•åµæ¸¬è³‡æ–™æ ¼å¼')
  .option('--interactive', 'äº’å‹•å¼é…ç½®')
  .action(importCommand)

program
  .command('list')
  .description('åˆ—å‡ºæ‰€æœ‰å¯ç”¨çµ„ä»¶')
  .option('-f, --filter <filter>', 'éæ¿¾çµ„ä»¶')
  .action(listCommand)

program
  .command('update <component>')
  .description('æ›´æ–°æŒ‡å®šçµ„ä»¶')
  .action(updateCommand)

// éŒ¯èª¤è™•ç†
program.on('command:*', () => {
  console.error(chalk.red(`æœªçŸ¥å‘½ä»¤: ${program.args.join(' ')}`))
  console.log(chalk.yellow('åŸ·è¡Œ d3-components --help æŸ¥çœ‹å¯ç”¨å‘½ä»¤'))
  process.exit(1)
})

// è§£æå‘½ä»¤è¡Œåƒæ•¸
program.parse()

// å¦‚æœæ²’æœ‰æä¾›ä»»ä½•å‘½ä»¤ï¼Œé¡¯ç¤ºå¹«åŠ©
if (!process.argv.slice(2).length) {
  program.outputHelp()
}
```

**é‡è¦èªªæ˜ï¼š**
- `#!/usr/bin/env node` æ˜¯ shebangï¼Œå‘Šè¨´ç³»çµ±ç”¨ Node.js åŸ·è¡Œæ­¤æª”æ¡ˆ
- `commander` æ˜¯æœ€å—æ­¡è¿çš„ Node.js CLI æ¡†æ¶
- æ¯å€‹ `.command()` å®šç¾©ä¸€å€‹å­å‘½ä»¤

## æ­¥é©Ÿä¸‰ï¼šå¯¦ä½œ Add å‘½ä»¤

### src/commands/add.ts
```typescript
import fs from 'fs-extra'
import path from 'path'
import chalk from 'chalk'
import ora from 'ora'
import inquirer from 'inquirer'
import { fetchComponentConfig, downloadComponentFiles } from '../utils/registry'
import { validateProject, updateProjectConfig } from '../utils/project'
import { processTemplateFiles } from '../utils/templates'

interface AddOptions {
  variant?: string
  dir?: string
  dryRun?: boolean
}

export async function addCommand(
  componentName: string,
  options: AddOptions
) {
  const spinner = ora()
  
  try {
    // 1. é¡¯ç¤ºé–‹å§‹è¨Šæ¯
    console.log(chalk.blue(`ğŸ“¦ æ­£åœ¨æ·»åŠ  ${componentName} çµ„ä»¶...`))
    
    // 2. é©—è­‰å°ˆæ¡ˆç’°å¢ƒ
    spinner.start('æª¢æŸ¥å°ˆæ¡ˆç’°å¢ƒ...')
    await validateProject()
    spinner.succeed('å°ˆæ¡ˆç’°å¢ƒæª¢æŸ¥å®Œæˆ')
    
    // 3. å¾ registry ç²å–çµ„ä»¶é…ç½®
    spinner.start('ç²å–çµ„ä»¶è³‡è¨Š...')
    const component = await fetchComponentConfig(componentName)
    if (!component) {
      spinner.fail(`æ‰¾ä¸åˆ°çµ„ä»¶: ${componentName}`)
      console.log(chalk.yellow('åŸ·è¡Œ d3-components list æŸ¥çœ‹å¯ç”¨çµ„ä»¶'))
      return
    }
    spinner.succeed('çµ„ä»¶è³‡è¨Šç²å–æˆåŠŸ')
    
    // 4. é¸æ“‡è®Šé«”
    const variant = await selectVariant(component, options.variant)
    
    // 5. æª¢æŸ¥ä¾è³´
    await checkDependencies(component.dependencies)
    
    // 6. ç¢ºèªç›®æ¨™ç›®éŒ„
    const targetDir = path.resolve(options.dir || './src/components/ui')
    await ensureDirectory(targetDir)
    
    // 7. é è¦½æ¨¡å¼
    if (options.dryRun) {
      console.log(chalk.yellow('ğŸ” é è¦½æ¨¡å¼ - ä¸æœƒå¯¦éš›å»ºç«‹æª”æ¡ˆ'))
      previewChanges(component, variant, targetDir)
      return
    }
    
    // 8. ä¸‹è¼‰ä¸¦å®‰è£çµ„ä»¶
    spinner.start('ä¸‹è¼‰çµ„ä»¶æª”æ¡ˆ...')
    await downloadAndInstallComponent(component, variant, targetDir)
    spinner.succeed('çµ„ä»¶æª”æ¡ˆä¸‹è¼‰å®Œæˆ')
    
    // 9. æ›´æ–°å°ˆæ¡ˆé…ç½®
    await updateProjectConfig(component, variant)
    
    // 10. é¡¯ç¤ºæˆåŠŸè¨Šæ¯å’Œä½¿ç”¨èªªæ˜
    showSuccessMessage(component, targetDir)
    
  } catch (error) {
    spinner.fail('æ·»åŠ çµ„ä»¶å¤±æ•—')
    console.error(chalk.red(`éŒ¯èª¤: ${error.message}`))
    
    if (process.env.DEBUG) {
      console.error(error.stack)
    }
    
    process.exit(1)
  }
}

async function selectVariant(
  component: ComponentConfig, 
  requestedVariant?: string
): Promise<string> {
  // å¦‚æœåªæœ‰ä¸€å€‹è®Šé«”æˆ–å·²æŒ‡å®šè®Šé«”
  if (component.variants.length === 1 || requestedVariant) {
    const variant = requestedVariant || component.variants[0]
    if (!component.variants.includes(variant)) {
      throw new Error(`è®Šé«” "${variant}" ä¸å­˜åœ¨æ–¼çµ„ä»¶ "${component.name}"`)
    }
    return variant
  }
  
  // äº’å‹•å¼é¸æ“‡è®Šé«”
  const { variant } = await inquirer.prompt([
    {
      type: 'list',
      name: 'variant',
      message: 'é¸æ“‡çµ„ä»¶è®Šé«”:',
      choices: component.variants.map(v => ({
        name: `${v} - ${component.variantDescriptions?.[v] || ''}`,
        value: v
      }))
    }
  ])
  
  return variant
}

async function checkDependencies(deps: string[]) {
  if (!deps.length) return
  
  const packageJsonPath = path.resolve('./package.json')
  const packageJson = await fs.readJSON(packageJsonPath)
  
  const allDeps = {
    ...packageJson.dependencies,
    ...packageJson.devDependencies
  }
  
  const missing = deps.filter(dep => !allDeps[dep])
  
  if (missing.length > 0) {
    console.log(chalk.yellow(`âš ï¸  ç¼ºå°‘ä¾è³´: ${missing.join(', ')}`))
    
    const { install } = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'install',
        message: 'æ˜¯å¦è¦å®‰è£ç¼ºå°‘çš„ä¾è³´ï¼Ÿ',
        default: true
      }
    ])
    
    if (install) {
      await installDependencies(missing)
    } else {
      console.log(chalk.yellow('è«‹æ‰‹å‹•å®‰è£ä¾è³´ï¼Œå¦å‰‡çµ„ä»¶å¯èƒ½ç„¡æ³•æ­£å¸¸é‹ä½œ'))
    }
  }
}

async function installDependencies(deps: string[]) {
  const { execSync } = require('child_process')
  
  // åµæ¸¬å¥—ä»¶ç®¡ç†å™¨
  const packageManager = detectPackageManager()
  
  const spinner = ora(`ä½¿ç”¨ ${packageManager} å®‰è£ä¾è³´...`).start()
  
  try {
    const installCmd = {
      npm: `npm install ${deps.join(' ')}`,
      yarn: `yarn add ${deps.join(' ')}`,
      pnpm: `pnpm add ${deps.join(' ')}`
    }[packageManager]
    
    execSync(installCmd, { stdio: 'ignore' })
    spinner.succeed('ä¾è³´å®‰è£å®Œæˆ')
  } catch (error) {
    spinner.fail('ä¾è³´å®‰è£å¤±æ•—')
    throw new Error('è«‹æ‰‹å‹•å®‰è£ç¼ºå°‘çš„ä¾è³´')
  }
}

function detectPackageManager(): 'npm' | 'yarn' | 'pnpm' {
  if (fs.existsSync('pnpm-lock.yaml')) return 'pnpm'
  if (fs.existsSync('yarn.lock')) return 'yarn'
  return 'npm'
}

async function ensureDirectory(dir: string) {
  await fs.ensureDir(dir)
}

async function downloadAndInstallComponent(
  component: ComponentConfig,
  variant: string,
  targetDir: string
) {
  const componentDir = path.join(targetDir, component.name)
  await fs.ensureDir(componentDir)
  
  // ä¸‹è¼‰æ‰€æœ‰æª”æ¡ˆ
  await downloadComponentFiles(component, variant, componentDir)
  
  // è™•ç†æ¨¡æ¿è®Šæ•¸
  await processTemplateFiles(componentDir, {
    componentName: component.name,
    variant,
    timestamp: new Date().toISOString()
  })
}

function previewChanges(
  component: ComponentConfig,
  variant: string,
  targetDir: string
) {
  console.log(chalk.blue('\nğŸ“‹ é è¦½è®Šæ›´:'))
  console.log(`çµ„ä»¶: ${component.name}`)
  console.log(`è®Šé«”: ${variant}`)
  console.log(`ç›®æ¨™ç›®éŒ„: ${targetDir}`)
  console.log('\nå°‡æœƒå»ºç«‹çš„æª”æ¡ˆ:')
  
  component.files.forEach(file => {
    const filePath = path.join(targetDir, component.name, file.name)
    console.log(chalk.green(`  + ${filePath}`))
  })
  
  if (component.dependencies.length > 0) {
    console.log('\néœ€è¦çš„ä¾è³´:')
    component.dependencies.forEach(dep => {
      console.log(chalk.yellow(`  â€¢ ${dep}`))
    })
  }
}

function showSuccessMessage(component: ComponentConfig, targetDir: string) {
  console.log(chalk.green('\nâœ… çµ„ä»¶æ·»åŠ æˆåŠŸ!'))
  console.log(chalk.gray(`ğŸ“ æª”æ¡ˆä½ç½®: ${path.join(targetDir, component.name)}`))
  
  // é¡¯ç¤ºä½¿ç”¨ç¯„ä¾‹
  if (component.example) {
    console.log(chalk.blue('\nğŸ“– ä½¿ç”¨ç¯„ä¾‹:'))
    console.log(chalk.gray(component.example))
  }
  
  // é¡¯ç¤ºç›¸é—œæª”æ¡ˆ
  console.log(chalk.blue('\nğŸ“„ ç›¸é—œæª”æ¡ˆ:'))
  component.files.forEach(file => {
    console.log(chalk.gray(`  â€¢ ${file.name} - ${file.description || ''}`))
  })
}
```

## æ­¥é©Ÿå››ï¼šRegistry ç³»çµ±

### src/utils/registry.ts
```typescript
import axios from 'axios'
import fs from 'fs-extra'
import path from 'path'
import { getCachedComponent, setCachedComponent } from './cache'

// Registry é…ç½®
const REGISTRY_URL = process.env.D3_COMPONENTS_REGISTRY || 'https://registry.d3-components.com'
const CACHE_TTL = 1000 * 60 * 60 // 1 å°æ™‚

export interface ComponentConfig {
  name: string
  description: string
  version: string
  dependencies: string[]
  files: FileConfig[]
  variants: string[]
  variantDescriptions?: Record<string, string>
  tags: string[]
  examples?: string[]
  example?: string
}

interface FileConfig {
  name: string
  type: 'component' | 'style' | 'type' | 'test'
  description?: string
}

export async function fetchComponentConfig(
  name: string
): Promise<ComponentConfig | null> {
  try {
    // å…ˆæª¢æŸ¥å¿«å–
    const cached = await getCachedComponent(name)
    if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
      return cached.data
    }
    
    // å¾é ç«¯ç²å–
    const response = await axios.get(`${REGISTRY_URL}/components/${name}/config.json`, {
      timeout: 10000
    })
    
    const config = response.data
    
    // æ›´æ–°å¿«å–
    await setCachedComponent(name, {
      data: config,
      timestamp: Date.now()
    })
    
    return config
    
  } catch (error) {
    if (error.response?.status === 404) {
      return null // çµ„ä»¶ä¸å­˜åœ¨
    }
    
    // ç¶²è·¯éŒ¯èª¤æ™‚å˜—è©¦ä½¿ç”¨å¿«å–
    const cached = await getCachedComponent(name)
    if (cached) {
      console.warn('ä½¿ç”¨å¿«å–çš„çµ„ä»¶é…ç½®ï¼ˆç¶²è·¯é€£ç·šå•é¡Œï¼‰')
      return cached.data
    }
    
    throw new Error(`ç„¡æ³•ç²å–çµ„ä»¶é…ç½®: ${error.message}`)
  }
}

export async function downloadComponentFiles(
  component: ComponentConfig,
  variant: string,
  targetDir: string
) {
  for (const file of component.files) {
    const fileUrl = `${REGISTRY_URL}/components/${component.name}/${variant}/${file.name}`
    const filePath = path.join(targetDir, file.name)
    
    try {
      const response = await axios.get(fileUrl, {
        timeout: 30000,
        responseType: 'text'
      })
      
      await fs.writeFile(filePath, response.data, 'utf8')
      
    } catch (error) {
      throw new Error(`ä¸‹è¼‰æª”æ¡ˆå¤±æ•— ${file.name}: ${error.message}`)
    }
  }
}

export async function listAllComponents(): Promise<ComponentConfig[]> {
  try {
    const response = await axios.get(`${REGISTRY_URL}/index.json`, {
      timeout: 10000
    })
    
    return response.data.components || []
    
  } catch (error) {
    throw new Error(`ç„¡æ³•ç²å–çµ„ä»¶åˆ—è¡¨: ${error.message}`)
  }
}

export async function searchComponents(query: string): Promise<ComponentConfig[]> {
  const allComponents = await listAllComponents()
  
  const searchTerm = query.toLowerCase()
  
  return allComponents.filter(component => {
    return (
      component.name.toLowerCase().includes(searchTerm) ||
      component.description.toLowerCase().includes(searchTerm) ||
      component.tags.some(tag => tag.toLowerCase().includes(searchTerm))
    )
  })
}
```

## æ­¥é©Ÿäº”ï¼šå°ˆæ¡ˆç®¡ç†å·¥å…·

### src/utils/project.ts
```typescript
import fs from 'fs-extra'
import path from 'path'
import chalk from 'chalk'

export async function validateProject() {
  // æª¢æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆçš„å°ˆæ¡ˆç›®éŒ„ä¸­
  const packageJsonPath = path.resolve('./package.json')
  
  if (!await fs.pathExists(packageJsonPath)) {
    throw new Error('è«‹åœ¨ Node.js å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸­åŸ·è¡Œæ­¤å‘½ä»¤')
  }
  
  // æª¢æŸ¥å°ˆæ¡ˆé¡å‹
  const packageJson = await fs.readJSON(packageJsonPath)
  
  if (!packageJson.dependencies?.react && !packageJson.devDependencies?.react) {
    console.warn(chalk.yellow('âš ï¸  åµæ¸¬åˆ°é React å°ˆæ¡ˆ'))
    console.warn(chalk.yellow('    éƒ¨åˆ†åŠŸèƒ½å¯èƒ½éœ€è¦æ‰‹å‹•èª¿æ•´'))
  }
  
  // æª¢æŸ¥ TypeScript æ”¯æ´
  const hasTypeScript = 
    packageJson.dependencies?.typescript ||
    packageJson.devDependencies?.typescript ||
    await fs.pathExists('./tsconfig.json')
  
  if (!hasTypeScript) {
    console.warn(chalk.yellow('âš ï¸  æœªåµæ¸¬åˆ° TypeScript'))
    console.warn(chalk.yellow('    å»ºè­°ä½¿ç”¨ TypeScript ä»¥ç²å¾—æ›´å¥½çš„é–‹ç™¼é«”é©—'))
  }
}

export async function updateProjectConfig(
  component: ComponentConfig,
  variant: string
) {
  const configPath = path.resolve('./d3-components.json')
  
  let config = {
    $schema: 'https://registry.d3-components.com/schema.json',
    components: []
  }
  
  if (await fs.pathExists(configPath)) {
    config = await fs.readJSON(configPath)
  }
  
  // æª¢æŸ¥æ˜¯å¦å·²å®‰è£
  const existingIndex = config.components.findIndex(c => c.name === component.name)
  
  const componentEntry = {
    name: component.name,
    variant,
    version: component.version,
    installedAt: new Date().toISOString()
  }
  
  if (existingIndex >= 0) {
    config.components[existingIndex] = componentEntry
  } else {
    config.components.push(componentEntry)
  }
  
  await fs.writeJSON(configPath, config, { spaces: 2 })
}

export async function getInstalledComponents(): Promise<any[]> {
  const configPath = path.resolve('./d3-components.json')
  
  if (!await fs.pathExists(configPath)) {
    return []
  }
  
  const config = await fs.readJSON(configPath)
  return config.components || []
}

export async function isComponentInstalled(name: string): Promise<boolean> {
  const installed = await getInstalledComponents()
  return installed.some(c => c.name === name)
}
```

## æ­¥é©Ÿå…­ï¼šå»ºæ§‹å’Œç™¼å¸ƒ

### å»ºæ§‹è…³æœ¬
```bash
# å»ºæ§‹å°ˆæ¡ˆ
npm run build

# æ¸¬è©¦ CLIï¼ˆæœ¬åœ°ï¼‰
npm link
d3-components --help

# å–æ¶ˆé€£çµ
npm unlink
```

### ç™¼å¸ƒåˆ° NPM
```bash
# ç™»å…¥ NPM
npm login

# ç™¼å¸ƒ
npm publish

# æŒ‡å®šæ¨™ç±¤ç™¼å¸ƒï¼ˆæ¸¬è©¦ç‰ˆæœ¬ï¼‰
npm publish --tag beta
```

### æ¸¬è©¦ç™¼å¸ƒçš„å¥—ä»¶
```bash
# æ¸¬è©¦å·²ç™¼å¸ƒçš„ç‰ˆæœ¬
npx d3-components@latest --help
```

## æ­¥é©Ÿä¸ƒï¼šé–‹ç™¼å’Œé™¤éŒ¯

### æœ¬åœ°é–‹ç™¼
```bash
# ç›£è¦–æ¨¡å¼å»ºæ§‹
npm run dev

# åœ¨å¦ä¸€å€‹çµ‚ç«¯ä¸­æ¸¬è©¦
node dist/index.js add bar-chart
```

### é™¤éŒ¯æŠ€å·§
```typescript
// æ·»åŠ é™¤éŒ¯æ¨¡å¼
if (process.env.DEBUG) {
  console.log('é™¤éŒ¯è³‡è¨Š:', { componentName, options })
}

// éŒ¯èª¤è™•ç†
try {
  // å±éšªæ“ä½œ
} catch (error) {
  if (process.env.DEBUG) {
    console.error('è©³ç´°éŒ¯èª¤:', error.stack)
  } else {
    console.error('éŒ¯èª¤:', error.message)
  }
}
```

### ä½¿ç”¨ç¯„ä¾‹
```bash
# é™¤éŒ¯æ¨¡å¼
DEBUG=1 npx d3-components add bar-chart

# é è¦½æ¨¡å¼
npx d3-components add bar-chart --dry-run

# æŒ‡å®šç›®éŒ„
npx d3-components add bar-chart --dir ./components
```

## å¸¸è¦‹å•é¡Œ

### Q: ç‚ºä»€éº¼éœ€è¦ `#!/usr/bin/env node`ï¼Ÿ
A: é€™æ˜¯ shebangï¼Œå‘Šè¨´ç³»çµ±ç”¨ Node.js åŸ·è¡Œæ­¤æª”æ¡ˆã€‚NPX æœƒè®€å– package.json çš„ `bin` æ¬„ä½ï¼Œç„¶å¾ŒåŸ·è¡Œå°æ‡‰çš„æª”æ¡ˆã€‚

### Q: å¦‚ä½•è™•ç†ä¸åŒä½œæ¥­ç³»çµ±çš„ç›¸å®¹æ€§ï¼Ÿ
A: ä½¿ç”¨ `path.resolve()` å’Œ `path.join()` è™•ç†è·¯å¾‘ï¼Œé¿å…ç¡¬ç·¨ç¢¼åˆ†éš”ç¬¦è™Ÿã€‚

### Q: å¦‚ä½•è™•ç†ç¶²è·¯é€£ç·šå•é¡Œï¼Ÿ
A: å¯¦ä½œå¿«å–æ©Ÿåˆ¶ï¼Œè¨­å®šé©ç•¶çš„ timeoutï¼Œä¸¦æä¾›é›¢ç·šæ¨¡å¼ã€‚

### Q: å¦‚ä½•æ¸¬è©¦ CLI å·¥å…·ï¼Ÿ
A: ä½¿ç”¨ Jest æ¸¬è©¦å€‹åˆ¥å‡½æ•¸ï¼Œä½¿ç”¨ `npm link` æ¸¬è©¦æ•´é«” CLI æµç¨‹ã€‚

---

é€™ä»½æŒ‡å—æ¶µè“‹äº†å»ºç«‹å®Œæ•´ CLI å·¥å…·çš„æ‰€æœ‰å¿…è¦çŸ¥è­˜ã€‚æŒ‰ç…§é€™äº›æ­¥é©Ÿï¼Œä½ å°±èƒ½å»ºç«‹ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„å‘½ä»¤åˆ—å·¥å…·ã€‚